import { xpRange } from '../lib/levelling.js';
import Canvacord from 'canvacord';

let handler = async (m, { conn }) => {
  let who = m.quoted ? m.quoted.sender : m.mentionedJid && m.mentionedJid[0] ? m.mentionedJid[0] : m.fromMe ? conn.user.jid : m.sender;

  if (!(who in global.db.data.users)) throw `âœ³ï¸ ğ™€ğ™¨ğ™©ğ™š ğ™ªğ™¨ğ™ªğ™–ğ™§ğ™ğ™¤ ğ™£ğ™¤ ğ™¨ğ™š ğ™šğ™£ğ™˜ğ™ªğ™šğ™£ğ™©ğ™§ğ™– ğ™šğ™£ ğ™¢ğ™ ğ™—ğ™–ğ™¨ğ™š ğ™™ğ™š ğ™™ğ™–ğ™©ğ™¤ğ™¨`;

  let pp = await conn.profilePictureUrl(who, 'image').catch(_ => './logo.jpg');
  let user = global.db.data.users[who];
  let { exp, level, role } = global.db.data.users[who];
  let { min, xp } = xpRange(user.level, global.multiplier);
  let username = conn.getName(who);

  let crxp = exp - min
  let customBackground  = './Assets/rankbg.jpg'
  let requiredXpToLevelUp = xp

  const card = await new Canvacord.Rank()
  .setAvatar(pp)
  .setLevel(level)
  .setCurrentXP(crxp) 
  .setRequiredXP(requiredXpToLevelUp) 
  .setProgressBar('#00BFFF', 'COLOR') 
  .setDiscriminator(who.substring(3, 7))
  .setCustomStatusColor('#00BFFF')
  .setLevelColor('#FFFFFF', '#FFFFFF')
  .setOverlay('#000000')
  .setUsername(username)
  .setBackground('IMAGE', customBackground)
  .setRank(level, 'LEVEL', false)
  .renderEmojis(true)
  .build();

  const str = `ğŸ® *ğ™‰ğ™¤ğ™¢ğ™—ğ™§ğ™š ğ™™ğ™š ğ™ªğ™¨ğ™ªğ™–ğ™§ğ™ğ™¤:* ${username}\n\nâ­ *ğ™€ğ™­ğ™¥ğ™šğ™§ğ™ğ™šğ™£ğ™˜ğ™ğ™–:* ${crxp} / ${requiredXpToLevelUp}\n\nğŸ… ğ™ğ™–ğ™£ğ™ :${global.rpg.role(level)}`

  try {
    conn.sendFile(m.chat, card, 'rank.jpg', str, m, false, { mentions: [who] });
    m.react('âœ…');
  } catch (error) {
    console.error(error);
  }
  
  
  const creditExpStr = `ğŸ’° ğ™¾ğšğ™¾: ${user.credit}\nğŸ”¹ ğ™¿ğšğš—ğšğš˜ğšœ ğšğš ğšğš¡ğš™ğšğš›ğš’ğšğš—ğšŒğš’ğšŠ: ${user.exp}`;
  
 
  const randomMessage = generateRandomMessage();
  
  
  const decorations = `
  *â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*
  ğŸŒŸ *ğ™½ğ™¸ğš…ğ™´ğ™»:* ${level}
  ğŸ–ï¸ *ğšğ™¾ğ™»:* ${global.rpg.role(level)}
  *â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*
  `;
  
  
  m.reply(`${creditExpStr}\n\n${randomMessage}\n\n${decorations}`);
}

handler.help = ['rank'];
handler.tags = ['economy'];
handler.command = ['rank','rango','estatus'];

export default handler;


function generateRandomMessage() {
  const messages = [
    'Â¡ğš‚ğš’ğšğšğš ğšŠğšœÃ­! ğŸ’ª',
    'Â¡ğ™´ğš¡ğšŒğšğš•ğšğš—ğšğš ğš™ğš›ğš˜ğšğš›ğšğšœğš˜! ğŸ‘',
    'Â¡ğšƒğš ğšğšœğšğšğšğš›ğš£ğš˜ ğšğšœğšÃ¡ ğšğšŠğš—ğšğš˜ ğš›ğšğšœğšğš•ğšğšŠğšğš˜ğšœ! ğŸ‰',
    'ğšğšğšŒğšğšğš›ğšğšŠ ğšœğš’ğšğš–ğš™ğš›ğš ğš–ğšŠğš—ğšğšğš—ğšğš›ğšğš ğšŠğšŒğšğš’ğšŸğš˜ ğšğš— ğšğš• ğš‹ğš˜ğš ğš™ğšŠğš›ğšŠ ğšğšŠğš—ğšŠğš› ğš–Ã¡ğšœ ğš™ğšğš—ğšğš˜ğšœ ğšğš ğšğš¡ğš™ğšğš›ğš’ğšğš—ğšŒğš’ğšŠ ğš¢ ğšŒğš›Ã©ğšğš’ğšğš˜ğšœ. ğŸ˜‰',
    'ğš‚ğš’ ğš—ğšğšŒğšğšœğš’ğšğšŠğšœ ğšŠğš¢ğšğšğšŠ ğš˜ ğšğš’ğšğš—ğšğšœ ğšŠğš•ğšğšğš—ğšŠ ğš™ğš›ğšğšğšğš—ğšğšŠ, ğš—ğš˜ ğšğšğšğšğšœ ğšğš— ğš™ğš›ğšğšğšğš—ğšğšŠğš› ğšğš— ğšğš• ğšğš›ğšğš™ğš˜. ğ™´ğšœğšğšŠğš–ğš˜ğšœ ğšŠğššğšÃ­ ğš™ğšŠğš›ğšŠ ğšŠğš¢ğšğšğšŠğš›ğšğš. ğŸ¤—',
    'ğ™½ğš˜ ğš˜ğš•ğšŸğš’ğšğšğšœ ğš›ğšğšŸğš’ğšœğšŠğš› ğš•ğš˜ğšœ ğš—ğšğšğšŸğš˜ğšœ ğšŒğš˜ğš–ğšŠğš—ğšğš˜ğšœ ğš¢ ğšğšğš—ğšŒğš’ğš˜ğš—ğšğšœ ğšŠğšğš›ğšğšğšŠğšğšŠğšœ ğšŠğš• ğš‹ğš˜ğš. Â¡ğ™¿ğšğšğšğšğš— ğšœğšğš› Ãºğšğš’ğš•ğšğšœ ğš™ğšŠğš›ğšŠ ğšğš’! ğŸš€',
    'Â¡ğ™»ğšŠ ğšŒğš˜ğš–ğšğš—ğš’ğšğšŠğš ğšğš ğšŠğšğš›ğšŠğšğšğšŒğš ğš™ğš˜ğš› ğšğš ğš™ğšŠğš›ğšğš’ğšŒğš’ğš™ğšŠğšŒğš’Ã³ğš— ğš¢ ğšŒğš˜ğš—ğšğš›ğš’ğš‹ğšğšŒğš’Ã³ğš—! ğŸŒŸ',
    'Â¡ğš‚ğš’ğšğšğš ğšœğšğš‹ğš’ğšğš—ğšğš˜ ğšğš ğš—ğš’ğšŸğšğš• ğš¢ ğšŠğš•ğšŒğšŠğš—ğš£ğšŠ ğš—ğšğšğšŸğšŠğšœ ğš–ğšğšğšŠğšœ ğšğš— ğšğš• ğš‹ğš˜ğš! ğŸ’«',
    'ğšğšğšŒğšğšğš›ğšğšŠ ğššğšğš ğšœğš’ğšğš–ğš™ğš›ğš ğš™ğšğšğšğšğšœ ğšŒğš˜ğš—ğšœğšğš•ğšğšŠğš› ğšğšğšœ ğšğšœğšğšŠğšÃ­ğšœğšğš’ğšŒğšŠğšœ ğš¢ ğš™ğš›ğš˜ğšğš›ğšğšœğš˜ ğšŒğš˜ğš— ğšğš• ğšŒğš˜ğš–ğšŠğš—ğšğš˜ *ğš›ğšŠğš—ğš”*.',
    'ğš‚ğš’ ğšğš ğšğšğšœğšğšŠ ğšğš• ğš‹ğš˜ğš, Â¡ğš—ğš˜ ğšğšğšğšğšœ ğšğš— ğšŒğš˜ğš–ğš™ğšŠğš›ğšğš’ğš›ğš•ğš˜ ğšŒğš˜ğš— ğšğšğšœ ğšŠğš–ğš’ğšğš˜ğšœ! ğŸ“²',
    'Â¡ğ™µğšğš•ğš’ğšŒğš’ğšğšŠğšğšğšœ ğš™ğš˜ğš› ğšğš ğšŠğšŸğšŠğš—ğšŒğš! ğŸŠ',
    'Â¡ğšƒğš ğšğšğšğš’ğšŒğšŠğšŒğš’Ã³ğš— ğšğšœ ğšŠğšğš–ğš’ğš›ğšŠğš‹ğš•ğš! ğŸ’–',
    'ğ™½ğšğš—ğšŒğšŠ ğšğšœ ğšğšŠğš›ğšğš ğš™ğšŠğš›ğšŠ ğšœğšğšğšğš’ğš› ğšŠğš™ğš›ğšğš—ğšğš’ğšğš—ğšğš˜ ğš¢ ğšŒğš›ğšğšŒğš’ğšğš—ğšğš˜. Â¡ğšƒÃº ğš™ğšğšğšğšğšœ! ğŸ’ª',
    'ğšğšğšŒğšğšğš›ğšğšŠ ğššğšğš ğšŒğšŠğšğšŠ ğš™ğšğššğšğšÃ±ğš˜ ğš™ğšŠğšœğš˜ ğšğš ğšŠğšŒğšğš›ğšŒğšŠ ğš–Ã¡ğšœ ğšŠ ğšğšğšœ ğš–ğšğšğšŠğšœ. Â¡ğš‚ğš’ğšğšğš ğšŠğšğšğš•ğšŠğš—ğšğš! ğŸš¶â€â™‚ï¸',
    'Â¡ğšƒğšğšœ ğš•ğš˜ğšğš›ğš˜ğšœ ğšœğš˜ğš— ğš’ğš—ğšœğš™ğš’ğš›ğšŠğšŒğš’Ã³ğš— ğš™ğšŠğš›ğšŠ ğš•ğš˜ğšœ ğšğšğš–Ã¡ğšœ! ğŸŒŸ',
    'ğ™´ğš• Ã©ğš¡ğš’ğšğš˜ ğš—ğš˜ ğšğšœ ğšœğš˜ğš•ğš˜ ğšğš• ğšğšğšœğšğš’ğš—ğš˜, ğšœğš’ğš—ğš˜ ğšğšŠğš–ğš‹ğš’Ã©ğš— ğšğš• ğšŸğš’ğšŠğš“ğš. Â¡ğ™³ğš’ğšœğšğš›ğšğšğšŠ ğšŒğšŠğšğšŠ ğš–ğš˜ğš–ğšğš—ğšğš˜! ğŸŒ„',
    'Â¡ğ™´ğšœğšğšÃ©ğš›ğš£ğšŠğšğš ğš™ğš˜ğš› ğšœğšğš› ğšğš—ğšŠ ğš–ğšğš“ğš˜ğš› ğšŸğšğš›ğšœğš’Ã³ğš— ğšğš ğšğš’ ğš–ğš’ğšœğš–ğš˜ ğšŒğšŠğšğšŠ ğšÃ­ğšŠ! ğŸŒŸ',
    'ğ™»ğšŠ ğš™ğšğš›ğšœğšğšŸğšğš›ğšŠğš—ğšŒğš’ğšŠ ğšğšœ ğš•ğšŠ ğšŒğš•ğšŠğšŸğš ğšğšğš• Ã©ğš¡ğš’ğšğš˜. Â¡ğ™½ğš˜ ğšğš ğš›ğš’ğš—ğšğšŠğšœ ğš—ğšğš—ğšŒğšŠ! ğŸ’ª',
    'Â¡ğ™´ğš• ğš•Ã­ğš–ğš’ğšğš ğšğšœ ğšœğš˜ğš•ğš˜ ğšğš—ğšŠ ğš’ğš•ğšğšœğš’Ã³ğš—! Â¡ğšƒÃº ğš™ğšğšğšğšğšœ ğšŠğš•ğšŒğšŠğš—ğš£ğšŠğš› ğš•ğš˜ ğššğšğš ğšğš ğš™ğš›ğš˜ğš™ğš˜ğš—ğšğšŠğšœ! ğŸš€',
    'ğšğšğšŒğšğšğš›ğšğšŠ ğššğšğš ğšŒğšŠğšğšŠ ğšğšğšœğšŠğšÃ­ğš˜ ğšğšœ ğšğš—ğšŠ ğš˜ğš™ğš˜ğš›ğšğšğš—ğš’ğšğšŠğš ğš™ğšŠğš›ğšŠ ğšŒğš›ğšğšŒğšğš› ğš¢ ğšŠğš™ğš›ğšğš—ğšğšğš›. ğŸ’¡',
  ];
  
  return messages[Math.floor(Math.random() * messages.length)];
}
